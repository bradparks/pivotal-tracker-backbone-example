/*global Backbone, $, PTrack: true *//*jshint curly: false, laxcomma: true */$(function(){var e;PTrack.dispatcher=_.extend({},Backbone.Events);PTrack.actions={ATTEMPT_LOGIN:"attemptLogin",LOGIN_FAILED:"loginFailed",LOGIN_SUCCESS:"loginSuccess",LOGOUT_SUCCESS:"logoutSuccess"};PTrack.session=new PTrack.Models.LoginToken;e=new PTrack.Routers.MainRouter({dispatcher:PTrack.dispatcher});var t=function(e){PTrack.session.set("username",e.username);PTrack.session.set("password",e.password);PTrack.session.fetch({success:function(e,t){PTrack.session.save();PTrack.dispatcher.trigger(PTrack.actions.LOGIN_SUCCESS,e,t)},error:function(e,t){PTrack.dispatcher.trigger(PTrack.actions.LOGIN_FAILED,e,t)}})};PTrack.dispatcher.on(PTrack.actions.ATTEMPT_LOGIN,t);Backbone.history.start({pushState:!0})});var PTrack=PTrack||{};Backbone.originalSync=Backbone.sync;Backbone.sync=function(e,t,n){var r=n.error;PTrack.session.isAuthenticated()&&(n.headers={"X-TrackerToken":PTrack.session.get("guid")});n.error=function(e,t,i){e.status===200&&e.statusText==="OK"?n.success(e.responseText,e.status):r(e,t,i)};Backbone.originalSync.apply(Backbone,[e,t,n])};(function(){PTrack.Models=PTrack.Models||{};PTrack.Models.LoginToken=Backbone.Model.extend({initialize:function(){this.load()},url:function(){return"https://www.pivotaltracker.com/services/v3/tokens/active"},fetch:function(e){e.headers={Authorization:"Basic "+btoa(this.get("username")+":"+this.get("password"))};return Backbone.Model.prototype.fetch.call(this,e)},parse:function(e){var t=$.parseXML(e),n;t=$(t);n=t.find("guid").text();return{guid:n}},isAuthenticated:function(){return Boolean(this.get("guid"))},load:function(){var e;e=localStorage.getItem("ptrack_session");if(e){e=localStorage.getItem("ptrack_session");e=JSON.parse(e);this.set("username",e.username);this.set("guid",e.guid)}},save:function(){var e={};e.username=this.get("username");e.guid=this.get("guid");localStorage.setItem("ptrack_session",JSON.stringify(e))},remove:function(){this.unset("guid");localStorage.removeItem("ptrack_session")}});PTrack.Models.Project=Backbone.Model.extend({parse:function(e){var t,n,r,i;if(typeof e=="string"){t=$.parseXML(e);t=$(t)}else t=$(e);n=t.find("id").text();r=t.find("> name").text();i=t.find("account").text();this.set("id",n);this.set("name",r);this.set("account",i)},urlRoot:function(){return"http://www.pivotaltracker.com/services/v3/projects"}})})();var PTrack=PTrack||{};(function(){PTrack.Collections=PTrack.Collections||{};PTrack.Collections.Projects=Backbone.Collection.extend({model:PTrack.Models.Project,initialize:function(){},parse:function(e){var t,n,r=[];t=$.parseXML(e);t=$(t);n=t.find("project");_.each(n,function(e){var t=new PTrack.Models.Project;t.parse(e);r.push(t)});return r},url:function(){return"http://www.pivotaltracker.com/services/v3/projects"}})})();var PTrack=PTrack||{};(function(){PTrack.Views=PTrack.Views||{};PTrack.Views.HeaderView=Backbone.View.extend({initialize:function(e){var t=this;this.dispatcher=e.dispatcher;this.setState(PTrack.session.isAuthenticated()?"login":"logout");this.dispatcher.on(PTrack.actions.LOGIN_SUCCESS,function(){t.setState("login")});this.dispatcher.on(PTrack.actions.LOGOUT_SUCCESS,function(){t.setState("logout")})},events:{"click nav.auth .login":"loginClickHandler","click nav.auth .logout":"logoutClickHandler","click nav.main .projects":"projectsClickHandler","click nav.main .activity":"activityClickHandler"},setState:function(e){if(e==="login"){$(this.el).find(".login").hide();$(this.el).find(".logout").show()}if(e==="logout"){$(this.el).find(".login").show();$(this.el).find(".logout").hide()}},loginClickHandler:function(){Backbone.history.navigate("login/",!0);return!1},logoutClickHandler:function(){Backbone.history.navigate("logout/",!0);return!1},projectsClickHandler:function(){Backbone.history.navigate("",!0);return!1},activityClickHandler:function(){alert("Not implemented");return!1}});PTrack.Views.ProjectsView=Backbone.View.extend({tagName:"div",initialize:function(e){this.dispatcher=e.dispatcher;this.template=_.template($("#projects-template").html());this.collection=e.collection},events:{"click .list .project":"projectClickHandler"},projectClickHandler:function(){alert("Not implemented");return!1},render:function(){$(this.el).html(this.template({projects:this.collection.toJSON()}))},destroy:function(){this.trigger("destroy");this.remove();this.unbind()},remove:function(){$(this.el).remove()}});PTrack.Views.LoginView=Backbone.View.extend({tagName:"div",initialize:function(e){this.dispatcher=e.dispatcher;this.template=_.template($("#login-template").html());this.error=""},events:{"click button":"submitHandler"},showError:function(e){this.error=e;this.render()},getUsername:function(){var e=$(this.el).find('input[name="username"]'),t=e.val();return t===undefined?"":t},getPassword:function(){var e=$(this.el).find('input[name="password"]'),t=e.val();return t===undefined?"":t},submitHandler:function(){this.trigger("submit",{username:this.getUsername(),password:this.getPassword()});return!1},render:function(){$(this.el).html(this.template({error:this.error,username:this.getUsername(),password:this.getPassword()}))},destroy:function(){this.trigger("destroy");this.remove();this.unbind()},remove:function(){$(this.el).remove()}})})();var PTrack=PTrack||{};(function(){PTrack.Routers=PTrack.Routers||{};PTrack.Routers.MainRouter=Backbone.Router.extend({routes:{"":"projectsRoute","login/":"loginRoute","logout/":"logoutRoute","projects/":"projectsRoute"},states:[],initialize:function(e){this.dispatcher=e.dispatcher;var t=new PTrack.Views.HeaderView({el:$("header"),dispatcher:e.dispatcher})},removeStates:function(){_.each(this.states,function(e){e.destroy()})},addState:function(e){this.states.push(e)},indexRoute:function(){if(!PTrack.session.isAuthenticated())return Backbone.history.navigate("login/",!0)},loginRoute:function(){this.removeStates();var e;e=new PTrack.Views.LoginView({dispatcher:this.dispatcher});e.render();$("#container").append(e.el);var t=function(e){this.dispatcher.trigger(PTrack.actions.ATTEMPT_LOGIN,e)},n=function(t){e.showError("Login failed")},r=function(e){return Backbone.history.navigate("",!0)},i=function(){e.off("submit",t);this.dispatcher.off(PTrack.actions.LOGIN_FAILED,n);this.dispatcher.off(PTrack.actions.LOGIN_SUCCESS,r);e.off("destroy",i)};e.on("submit",t);this.dispatcher.on(PTrack.actions.LOGIN_FAILED,n);this.dispatcher.on(PTrack.actions.LOGIN_SUCCESS,r);e.on("destroy",i);this.addState(e)},logoutRoute:function(){if(!PTrack.session.isAuthenticated())return Backbone.history.navigate("login/",!0);PTrack.session.remove();this.dispatcher.trigger(PTrack.actions.LOGOUT_SUCCESS);return Backbone.history.navigate("login/",!0)},projectsRoute:function(){if(!PTrack.session.isAuthenticated())return Backbone.history.navigate("login/",!0);this.removeStates();var e,t;e=new PTrack.Collections.Projects;t=new PTrack.Views.ProjectsView({dispatcher:this.dispatcher,collection:e});t.render();$("#container").append(t.el);e.bind("reset",t.render,t);e.fetch();var n=function(){e.unbind("reset",t.render,t)};t.on("destroy",n);this.addState(t)}})})();